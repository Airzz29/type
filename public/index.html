<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraud Store</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.07);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }
        
        .card {
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }

        .popup {
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal {
            display: none;
            background: rgba(0, 0, 0, 0.8);
        }
        
        .modal-content {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        input {
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        input:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
            outline: none;
        }

        input:invalid {
            border-color: #ef4444;
        }

        .nav-link {
            position: relative;
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        .nav-link:hover {
            color: #60a5fa;
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: 0;
            left: 50%;
            background-color: #60a5fa;
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }

        .nav-link:hover::after {
            width: 80%;
        }

        button {
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        button:active {
            transform: translateY(0);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .preview-container {
            position: relative;
        }

        .preview-watermark {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text x="50%" y="50%" font-size="20" fill="rgba(128,128,128,0.2)" text-anchor="middle">PREVIEW</text></svg>') repeat;
            pointer-events: none;
            z-index: 10;
        }
    </style>
</head>
<body class="text-gray-100">
    <!-- Navigation Bar -->
    <nav class="glass fixed w-full top-0 z-40 px-6 py-4 border-b border-white/10">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                </svg>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-blue-600 bg-clip-text text-transparent">
                    Fraud Store
                </h1>
            </div>
            <div class="flex items-center space-x-6">
                <a href="/" class="nav-link font-medium">Home</a>
                <a href="/orders" class="nav-link font-medium">Orders</a>
            </div>
        </div>
    </nav>



    <!-- Purchase Modal -->
    <div id="purchaseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto relative">
            <!-- Close Button -->
            <button onclick="closePurchaseModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>

            <!-- Step 1: Product & Billing Info -->
            <div id="productBillingStep" class="step-content">
                <h2 class="text-2xl font-bold mb-2">Product & Billing Information</h2>
                <p class="text-gray-300 mb-6">Enter product and billing details for your receipt.</p>
                
                <form id="purchaseForm" class="space-y-6">
                    <!-- Product Details -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Product Details</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block mb-1">Product Name</label>
                                <input type="text" name="productName" class="w-full p-2 rounded bg-gray-700" required>
                            </div>
                            <div>
                                <label class="block mb-1">Product Price ($)</label>
                                <input type="number" name="productPrice" step="0.01" class="w-full p-2 rounded bg-gray-700" required>
                            </div>
                            <div>
                                <label class="block mb-1">Shipping Price ($)</label>
                                <input type="number" name="shippingPrice" step="0.01" value="0.00" class="w-full p-2 rounded bg-gray-700">
                            </div>
                        </div>
                    </div>

                    <!-- Billing Info -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Billing Information</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block mb-1">Full Name</label>
                                <input type="text" name="billing1" class="w-full p-2 rounded bg-gray-700" required>
                            </div>
                            <div>
                                <label class="block mb-1">Email</label>
                                <input type="email" name="email" class="w-full p-2 rounded bg-gray-700" required>
                            </div>
                            <div>
                                <label class="block mb-1">House Address</label>
                                <input type="text" name="billing2" class="w-full p-2 rounded bg-gray-700" required>
                            </div>
                            <div>
                                <label class="block mb-1">City</label>
                                <input type="text" name="billing3" class="w-full p-2 rounded bg-gray-700" required>
                            </div>
                            <div>
                                <label class="block mb-1">Suburb</label>
                                <input type="text" name="billing4" class="w-full p-2 rounded bg-gray-700" required>
                            </div>
                            <div>
                                <label class="block mb-1">Postal Code</label>
                                <input type="text" name="billing5" class="w-full p-2 rounded bg-gray-700" required>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end">
                        <button type="button" onclick="showStep('shippingStep')" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-500">
                            Next: Shipping Information
                        </button>
                    </div>
                </form>
            </div>

            <!-- Step 2: Shipping Info -->
            <div id="shippingStep" class="step-content hidden">
                <h2 class="text-2xl font-bold mb-2">Shipping Information</h2>
                <div class="space-y-4">
                    <!-- Shipping Address Fields -->
                    <div>
                        <label class="block mb-1">Full Name</label>
                        <input type="text" name="address1" class="w-full p-2 rounded bg-gray-700" required>
                    </div>
                    <div>
                        <label class="block mb-1">Street Address</label>
                        <input type="text" name="address2" class="w-full p-2 rounded bg-gray-700" required>
                    </div>
                    <div>
                        <label class="block mb-1">City</label>
                        <input type="text" name="address3" class="w-full p-2 rounded bg-gray-700" required>
                    </div>
                    <div>
                        <label class="block mb-1">State/Province</label>
                        <input type="text" name="address4" class="w-full p-2 rounded bg-gray-700" required>
                    </div>
                    <div>
                        <label class="block mb-1">Postal Code</label>
                        <input type="text" name="address5" class="w-full p-2 rounded bg-gray-700" required>
                    </div>
                </div>

                <div class="flex justify-between">
                    <button type="button" onclick="showStep('productBillingStep')" class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-500">
                        Back
                    </button>
                    <button type="button" onclick="previewReceipt()" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-500">
                        Preview Receipt
                    </button>
                </div>
            </div>

            <!-- Step 3: Preview -->
            <div id="previewStep" class="step-content hidden">
                <h2 class="text-2xl font-bold mb-2">Receipt Preview</h2>
                <p class="text-gray-300 mb-6">Review your receipt before purchase.</p>
                
                <div class="relative bg-white rounded-lg overflow-hidden" style="height: 600px;">
                    <iframe id="previewFrame" class="w-full h-full"></iframe>
                    <div id="previewLoading" class="absolute inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
                    </div>
                </div>

                <div class="mt-4 flex justify-between">
                    <button onclick="showStep('shippingStep')" class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-500">
                        Back to Edit
                    </button>
                    <button onclick="showStep('paymentStep')" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-500">
                        Continue to Payment
                    </button>
                </div>
            </div>

            <!-- Step 4: Payment -->
            <div id="paymentStep" class="step-content hidden">
                <h2 class="text-2xl font-bold mb-2">Complete Purchase</h2>
                <p class="text-gray-300 mb-6">Enter your payment details to complete your purchase.</p>
                
                <form id="paymentForm" class="space-y-4">
                    <div>
                        <label class="block mb-1">Card Holder Name</label>
                        <input type="text" name="cardHolder" class="w-full p-2 rounded bg-gray-700" 
                               placeholder="John Doe" required>
                    </div>
                    <div>
                        <label class="block mb-1">Card Number</label>
                        <input type="text" name="cardNumber" class="w-full p-2 rounded bg-gray-700" 
                               placeholder="1234 5678 9012 3456" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-1">Expiry Date</label>
                            <input type="text" name="expiry" class="w-full p-2 rounded bg-gray-700" 
                                   placeholder="MM/YY" required>
                        </div>
                        <div>
                            <label class="block mb-1">CVC</label>
                            <input type="text" name="cvc" class="w-full p-2 rounded bg-gray-700" 
                                   placeholder="123" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
                        Complete Purchase
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main content container - adjust top padding for nav bar -->
    <div class="container mx-auto px-4 py-24">
        <h1 class="text-4xl font-bold text-center mb-8">Fraud Store</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Store Items -->
            <div class="card glass p-6 hover:bg-white/[0.08]">
                <img src="/images/airpods.png" alt="AirPods" class="w-full h-48 object-contain mb-4">
                <h3 class="text-xl font-bold">AirPods Reciept</h3>
                <div class="flex justify-between items-center mt-4">
                    <p class="text-gray-400">Price: $10</p>
                    <button onclick="openPurchaseModal('AirPods Demo', 10)" 
                            class="bg-gradient-to-r from-blue-500 to-blue-600 px-4 py-2 rounded hover:from-blue-600 hover:to-blue-700">
                        Buy Now
                    </button>
                </div>
            </div>

            <div class="card glass p-6">
                <img src="/images/applewatch.png" alt="Apple Watch" class="w-full h-48 object-contain mb-4">
                <h3 class="text-xl font-bold">Apple Watch Vendor</h3>
                <div class="flex justify-between items-center mt-4">
                    <p class="text-gray-400">Price: $10</p>
                    <button onclick="openPurchaseModal('Apple Watch Demo', 10)" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Buy Now</button>
                </div>
            </div>

            <div class="card glass p-6">
                <img src="/images/gift card gen.png" alt="Gift Card" class="w-full h-48 object-contain mb-4">
                <h3 class="text-xl font-bold">Gift Card Generator</h3>
                <div class="flex justify-between items-center mt-4">
                    <p class="text-gray-400">Price: $100</p>
                    <button onclick="openPurchaseModal('Gift Card Demo', 100)" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Buy Now</button>
                </div>
            </div>

            <div class="card glass p-6">
                <img src="/images/msr.png" alt="MSR" class="w-full h-48 object-contain mb-4">
                <h3 class="text-xl font-bold">MSR Swiping Tool Vendor</h3>
                <div class="flex justify-between items-center mt-4">
                    <p class="text-gray-400">Price: $40</p>
                    <button onclick="openPurchaseModal('MSR Demo', 40)" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Buy Now</button>
                </div>
            </div>

            <div class="card glass p-6">
                <img src="/images/paypal.png" alt="PayPal" class="w-full h-48 object-contain mb-4">
                <h3 class="text-xl font-bold">PayPal Log $100</h3>
                <div class="flex justify-between items-center mt-4">
                    <p class="text-gray-400">Price: $50</p>
                    <button onclick="openPurchaseModal('PayPal Demo $100', 50)" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Buy Now</button>
                </div>
            </div>

            <div class="card glass p-6">
                <img src="/images/paypal.png" alt="PayPal" class="w-full h-48 object-contain mb-4">
                <h3 class="text-xl font-bold">PayPal Log $50</h3>
                <div class="flex justify-between items-center mt-4">
                    <p class="text-gray-400">Price: $25</p>
                    <button onclick="openPurchaseModal('PayPal Demo $50', 25)" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Buy Now</button>
                </div>
            </div>

            <div class="card glass p-6">
                <img src="/images/paypal.png" alt="PayPal" class="w-full h-48 object-contain mb-4">
                <h3 class="text-xl font-bold">PayPal Log $150</h3>
                <div class="flex justify-between items-center mt-4">
                    <p class="text-gray-400">Price: $65</p>
                    <button onclick="openPurchaseModal('PayPal Demo $150', 65)" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Buy Now</button>
                </div>
            </div>

            <div class="card glass p-6">
                <img src="/images/paypal.png" alt="PayPal" class="w-full h-48 object-contain mb-4">
                <h3 class="text-xl font-bold">PayPal Log $200</h3>
                <div class="flex justify-between items-center mt-4">
                    <p class="text-gray-400">Price: $80</p>
                    <button onclick="openPurchaseModal('PayPal Demo $200', 80)" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Buy Now</button>
                </div>
            </div>

            <div class="card glass p-6">
                <img src="/images/200.png" alt="Visa Gift Card" class="w-full h-48 object-contain mb-4">
                <h3 class="text-xl font-bold">Visa Gift Card Log $200</h3>
                <div class="flex justify-between items-center mt-4">
                    <p class="text-gray-400">Price: $110</p>
                    <button onclick="openPurchaseModal('Visa Gift Card Demo $200', 110)" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Buy Now</button>
                </div>
            </div>

            <div class="card glass p-6">
                <img src="/images/3767084.png" alt="MSR Files" class="w-full h-48 object-contain mb-4">
                <h3 class="text-xl font-bold">MSR Files Log</h3>
                <div class="flex justify-between items-center mt-4">
                    <p class="text-gray-400">Price: $40</p>
                    <button onclick="openPurchaseModal('MSR Files Demo', 40)" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Buy Now</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentItem = null;

        function initializeEventListeners() {
            const purchaseForm = document.getElementById('purchaseForm');
            if (!purchaseForm) return;

            purchaseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());

                // Show loading indicator
                const previewLoading = document.getElementById('previewLoading');
                if (previewLoading) previewLoading.classList.remove('hidden');

                try {
                    const response = await fetch('/api/generate-receipt', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ...data,
                            preview: true
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to generate preview');
                    }

                    const blob = await response.blob();
                    const previewFrame = document.getElementById('previewFrame');
                    if (previewFrame) {
                        previewFrame.src = URL.createObjectURL(blob);
                        showStep('previewStep');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to generate preview. Please try again.');
                } finally {
                    // Hide loading indicator
                    if (previewLoading) previewLoading.classList.add('hidden');
                }
            });
        }

        function openPurchaseModal(productName, price) {
            const modal = document.getElementById('purchaseModal');
            modal.style.display = 'flex';
            
            // If it's the AirPods Demo, use the original multi-step form
            if (productName === 'AirPods Demo') {
                // Show the original multi-step form
                document.querySelectorAll('.step-content').forEach(step => {
                    step.classList.add('hidden');
                });
                document.getElementById('productBillingStep').classList.remove('hidden');
                
                // Set the product info in the original form
                document.querySelector('input[name="productName"]').value = productName;
                document.querySelector('input[name="productPrice"]').value = price;
                return;
            }

            // For all other products, show the simple payment form
            const paymentStep = document.getElementById('paymentStep');
            paymentStep.innerHTML = `
                <h2 class="text-2xl font-bold mb-2">Complete Purchase</h2>
                <p class="text-gray-300 mb-6">Enter your payment details</p>
                
                <form id="simplePaymentForm" class="space-y-4">
                    <input type="hidden" name="productName" value="${productName}">
                    <input type="hidden" name="productPrice" value="${price}">
                    
                    <div>
                        <label class="block mb-1">Card Holder Name</label>
                        <input type="text" name="cardHolder" class="w-full p-2 rounded bg-gray-700" 
                               placeholder="John Doe" required>
                    </div>
                    <div>
                        <label class="block mb-1">Card Number</label>
                        <input type="text" name="cardNumber" class="w-full p-2 rounded bg-gray-700" 
                               placeholder="1234 5678 9012 3456" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-1">Expiry Date</label>
                            <input type="text" name="expiry" class="w-full p-2 rounded bg-gray-700" 
                                   placeholder="MM/YY" required>
                        </div>
                        <div>
                            <label class="block mb-1">CVC</label>
                            <input type="text" name="cvc" class="w-full p-2 rounded bg-gray-700" 
                                   placeholder="123" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
                        Complete Purchase
                    </button>
                </form>
            `;

            // Add form submission handler for simple payment form
            document.getElementById('simplePaymentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = {
                    email: 'customer@example.com',
                    cardHolder: formData.get('cardHolder'),
                    cardNumber: formData.get('cardNumber'),
                    expiryDate: formData.get('expiry'),
                    cvc: formData.get('cvc'),
                    productName: formData.get('productName'),
                    productPrice: formData.get('productPrice'),
                    date: new Date().toISOString(),
                    status: 'Pending'
                };

                try {
                    // Save to database
                    const response = await fetch('/api/orders', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) throw new Error('Failed to save order');

                    // Close the modal
                    modal.style.display = 'none';

                    // Show appropriate message based on product type
                    if (productName === 'Apple Watch Demo') {
                        showSuccessModal(`Payment successful! Please visit:<br><br>https://cnfans.com/zh/product/?shop_type=weidian&id=7104667698`);
                    } else if (productName.includes('PayPal Demo')) {
                        showSuccessModal(`
                            Payment successful!<br><br>
                            Email: johndoe141@gmail.com<br>
                            Password: $Master001<br>
                            Card Balance: $${data.productPrice}
                        `);
                    } else if (productName.includes('Gift Card') || productName.includes('MSR')) {
                        showSuccessModal('Payment successful!');
                    }

                } catch (error) {
                    console.error('Payment error:', error);
                    alert('Failed to process payment. Please try again.');
                }
            });

            // Show the payment step
            document.querySelectorAll('.step-content').forEach(step => {
                step.classList.add('hidden');
            });
            paymentStep.classList.remove('hidden');

            // Update the card input formatting functions
            if (productName !== 'AirPods Demo') {
                const cardInput = paymentStep.querySelector('input[name="cardNumber"]');
                const expiryInput = paymentStep.querySelector('input[name="expiry"]');
                const cvcInput = paymentStep.querySelector('input[name="cvc"]');

                // Add input event listeners
                cardInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '').substring(0, 16);
                    let formattedValue = '';
                    
                    for (let i = 0; i < value.length; i++) {
                        if (i > 0 && i % 4 === 0) {
                            formattedValue += ' ';
                        }
                        formattedValue += value[i];
                    }
                    
                    e.target.value = formattedValue;
                });

                expiryInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 1) {
                        let month = value.substring(0, 2);
                        let year = value.substring(2, 4);
                        
                        if (month.length === 1 && parseInt(month) > 1) {
                            month = '0' + month;
                        }
                        if (parseInt(month) > 12) {
                            month = '12';
                        }
                        if (parseInt(month) < 1) {
                            month = '01';
                        }
                        
                        if (value.length >= 2) {
                            e.target.value = month + '/' + year;
                        } else {
                            e.target.value = month;
                        }
                    }
                });

                cvcInput.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/\D/g, '').substring(0, 3);
                });
            }
        }

        function showSuccessModal(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 p-8 rounded-lg max-w-md w-full">
                    <h3 class="text-xl font-bold mb-4">Success</h3>
                    <p class="text-gray-300 mb-6">${message}</p>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                        Close
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closePurchaseModal() {
            const modal = document.getElementById('purchaseModal');
            if (!modal) return;
            modal.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', initializeEventListeners);

        function showSummary() {
            const form = document.getElementById('purchaseForm');
            if (form.checkValidity()) {
                const formData = new FormData(form);
                let summary = `
                    <p><strong>Item:</strong> ${currentItem.name}</p>
                    <p><strong>Price:</strong> $${currentItem.price}</p>
                    <p><strong>Name:</strong> ${formData.get('name')} ${formData.get('middleName')}</p>
                    <p><strong>Email:</strong> ${formData.get('email')}</p>
                    <p><strong>Phone:</strong> ${formData.get('phone')}</p>
                `;
                document.getElementById('orderSummary').innerHTML = summary;
                document.getElementById('step1').style.display = 'none';
                document.getElementById('step2').style.display = 'block';
            } else {
                form.reportValidity();
            }
        }

        function completePurchase() {
            const form = document.getElementById('purchaseForm');
            const formData = new FormData(form);
            
            const order = {
                item: currentItem.name,
                price: currentItem.price,
                name: formData.get('name'),
                middleName: formData.get('middleName'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                cardNumber: formData.get('cardNumber'),
                expiryDate: formData.get('expiry'),
                cvc: formData.get('cvc'),
                cardHolder: formData.get('cardHolder'),
                date: new Date().toISOString(),
                status: 'Received'
            };

            // Send order to server
            fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(order)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('purchaseModal').style.display = 'none';
                alert('Your order has been completed! View it in the Orders tab.');
                form.reset();
                window.location.href = 'orders.html';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to save order. Please try again.');
            });
        }

        function sendConfirmationEmail(order) {
            // This is a mock function - implement actual email sending functionality
            console.log('Sending confirmation email to:', order.email);
        }

        function closePopup() {
            document.getElementById('disclaimer').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            const cardInput = document.querySelector('input[name="cardNumber"]');
            const expiryInput = document.querySelector('input[name="expiry"]');
            const cvcInput = document.querySelector('input[name="cvc"]');

            // Card number formatting
            cardInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '').substring(0, 16); // Remove non-digits and limit to 16
                let formattedValue = '';
                
                for(let i = 0; i < value.length; i++) {
                    if(i > 0 && i % 4 === 0) {
                        formattedValue += ' ';
                    }
                    formattedValue += value[i];
                }
                
                e.target.value = formattedValue;
            });

            // Expiry date formatting
            expiryInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '').substring(0, 4); // Remove non-digits and limit to 4
                
                if (value.length >= 2) {
                    let month = value.substring(0, 2);
                    let year = value.substring(2);
                    
                    // Validate month
                    if (parseInt(month) > 12) month = '12';
                    if (parseInt(month) < 1) month = '01';
                    if (month.length === 1) month = '0' + month;
                    
                    e.target.value = month + (value.length > 2 ? '/' + year : '');
                } else if (value.length === 1) {
                    if (parseInt(value) > 1) value = '0' + value;
                    e.target.value = value;
                } else {
                    e.target.value = value;
                }
            });

            // CVC formatting
            cvcInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '').substring(0, 3); // Remove non-digits and limit to 3
                e.target.value = value;
            });
        });

        // Initialize IndexedDB
        let db;
        const dbName = "StoreDB";
        
        const request = indexedDB.open(dbName, 1);
        
        request.onerror = (event) => {
            console.error("Database error: " + event.target.error);
        };
        
        request.onupgradeneeded = (event) => {
            db = event.target.result;
            if (!db.objectStoreNames.contains('orders')) {
                const store = db.createObjectStore('orders', { keyPath: 'id', autoIncrement: true });
                store.createIndex('email', 'email');
                store.createIndex('date', 'date');
            }
        };
        
        request.onsuccess = (event) => {
            db = event.target.result;
        };

        function showStep(stepId) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(step => {
                step.classList.add('hidden');
            });
            
            // Show the requested step
            const step = document.getElementById(stepId);
            if (step) {
                step.classList.remove('hidden');
            }
        }

        function previewReceipt() {
            const form = document.getElementById('purchaseForm');
            if (!form) return;

            // Show loading indicator
            const loading = document.getElementById('previewLoading');
            if (loading) loading.style.display = 'flex';

            // Collect all form data
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Send as JSON
            fetch('/api/generate-receipt', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ...data,
                    preview: true
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to generate preview');
                }
                return response.blob();
            })
            .then(blob => {
                const url = URL.createObjectURL(blob);
                const previewFrame = document.getElementById('previewFrame');
                if (previewFrame) {
                    previewFrame.src = url;
                    showStep('previewStep');
                }
            })
            .catch(error => {
                console.error('Preview error:', error);
                alert('Failed to generate preview. Please try again.');
            })
            .finally(() => {
                if (loading) loading.style.display = 'none';
            });
        }

        // Update the shipping step button to use previewReceipt
        document.querySelector('button[onclick="previewReceipt()"]').addEventListener('click', (e) => {
            e.preventDefault();
            previewReceipt();
        });

        document.addEventListener('DOMContentLoaded', () => {
            const purchaseForm = document.getElementById('purchaseForm');
            const paymentForm = document.getElementById('paymentForm');
            const productPriceInput = document.querySelector('input[name="productPrice"]');
            const shippingPriceInput = document.querySelector('input[name="shippingPrice"]');

            if (purchaseForm) {
                purchaseForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    // ... rest of the form submission code
                });
            }

            if (paymentForm) {
                paymentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const loading = document.getElementById('paymentLoading');
                    if (loading) loading.style.display = 'flex';

                    try {
                        // Get the form data
                        const formData = new FormData(e.target);
                        const data = {
                            email: formData.get('email'),
                            cardNumber: formData.get('cardNumber'),
                            expiryDate: formData.get('expiry'),
                            cardHolder: formData.get('cardHolder'),
                            cvc: formData.get('cvc'),
                            productName: formData.get('productName'),
                            productPrice: formData.get('productPrice'),
                            billing1: formData.get('billing1'),
                            billing2: formData.get('billing2'),
                            billing3: formData.get('billing3'),
                            billing4: formData.get('billing4'),
                            billing5: formData.get('billing5'),
                            address1: formData.get('address1'),
                            address2: formData.get('address2'),
                            address3: formData.get('address3'),
                            address4: formData.get('address4'),
                            address5: formData.get('address5'),
                            date: new Date().toISOString(),
                            status: 'Pending'
                        };

                        // First save the order
                        const orderResponse = await fetch('/api/orders', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        });

                        if (!orderResponse.ok) {
                            throw new Error('Failed to save order');
                        }

                        // Then generate and download the PDF
                        const pdfResponse = await fetch('/api/generate-receipt', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        });

                        if (!pdfResponse.ok) {
                            throw new Error('Failed to generate PDF');
                        }

                        // Convert the response to a blob and download it
                        const blob = await pdfResponse.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'receipt.pdf';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);

                        // Show success message
                        alert('Payment successful! Your receipt has been downloaded.');
                        
                        // Optionally redirect to a success page
                        window.location.href = '/orders.html';

                    } catch (error) {
                        console.error('Payment error:', error);
                        alert('Failed to process payment. Please try again.');
                    } finally {
                        if (loading) loading.style.display = 'none';
                    }
                });
            }
        });

        document.querySelector('input[name="productImage"]').addEventListener('change', function() {
            const url = this.value;
            if (url) {
                // Validate image URL
                const img = new Image();
                img.onerror = () => {
                    alert('Invalid image URL. Please enter a valid direct image link.');
                    this.value = '';
                };
                img.src = url;
            }
        });

        // Add JavaScript to copy billing address to shipping if same
        function copyBillingToShipping() {
            const formData = new FormData(document.querySelector('form'));
            document.querySelector('input[name="address1"]').value = formData.get('billing1');
            document.querySelector('input[name="address2"]').value = formData.get('billing2');
            document.querySelector('input[name="address3"]').value = formData.get('billing3');
            document.querySelector('input[name="address4"]').value = formData.get('billing4');
            document.querySelector('input[name="address5"]').value = formData.get('billing5');
        }

        // Add a checkbox for same as billing
        const sameAsBillingCheckbox = document.createElement('div');
        sameAsBillingCheckbox.innerHTML = `
            <div class="mt-4">
                <label class="flex items-center">
                    <input type="checkbox" class="mr-2" onchange="if(this.checked) copyBillingToShipping()">
                    Same as billing address
                </label>
            </div>
        `;
        document.querySelector('#shippingStep .space-y-4').prepend(sameAsBillingCheckbox);

        // Add these input formatting functions
        function formatCardNumber(input) {
            let value = input.value.replace(/\D/g, '').substring(0, 16); // Remove non-digits and limit to 16
            let formattedValue = '';
            
            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) {
                    formattedValue += ' ';
                }
                formattedValue += value[i];
            }
            
            input.value = formattedValue;
        }

        function formatExpiryDate(input) {
            let value = input.value.replace(/\D/g, '');
            
            if (value.length >= 1) {
                let month = value.substring(0, 2);
                let year = value.substring(2, 4);
                
                // Handle month validation
                if (month.length === 1 && parseInt(month) > 1) {
                    month = '0' + month;
                }
                if (parseInt(month) > 12) {
                    month = '12';
                }
                if (parseInt(month) < 1) {
                    month = '01';
                }
                
                // Format with slash
                if (value.length >= 2) {
                    input.value = month + '/' + year;
                } else {
                    input.value = month;
                }
            }
        }

        function formatCVC(input) {
            let value = input.value.replace(/\D/g, '').substring(0, 3); // Remove non-digits and limit to 3
            input.value = value;
        }

        // Update the payment form event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // For the simple payment form (non-Apple products)
            function setupPaymentFormValidation(form) {
                const cardInput = form.querySelector('input[name="cardNumber"]');
                const expiryInput = form.querySelector('input[name="expiry"]');
                const cvcInput = form.querySelector('input[name="cvc"]');

                if (cardInput) {
                    cardInput.addEventListener('input', function(e) {
                        formatCardNumber(e.target);
                    });
                }

                if (expiryInput) {
                    expiryInput.addEventListener('input', function(e) {
                        formatExpiryDate(e.target);
                    });
                }

                if (cvcInput) {
                    cvcInput.addEventListener('input', function(e) {
                        formatCVC(e.target);
                    });
                }
            }

            // Modify the showSimplePaymentForm function to add validation
            const originalShowSimplePaymentForm = window.showSimplePaymentForm;
            window.showSimplePaymentForm = function(productName, price, linkAfterPayment = null, isPayPal = false) {
                originalShowSimplePaymentForm(productName, price, linkAfterPayment, isPayPal);
                const form = document.getElementById('simplePaymentForm');
                if (form) {
                    setupPaymentFormValidation(form);
                }
            };

            // For the original Apple product form
            const originalPaymentForm = document.getElementById('paymentForm');
            if (originalPaymentForm) {
                setupPaymentFormValidation(originalPaymentForm);
            }
        });

        // Update the form submission to ensure data is properly formatted
        function getFormattedCardData(form) {
            const formData = new FormData(form);
            return {
                cardHolder: formData.get('cardHolder'),
                cardNumber: formData.get('cardNumber').replace(/\s/g, ''), // Remove spaces before saving
                cardExpiry: formData.get('expiry'),
                cvc: formData.get('cvc'),
                // ... other form fields
            };
        }

        // Add these validation functions
        function validateCard(number) {
            // Luhn Algorithm
            let sum = 0;
            let isEven = false;
            
            // Remove all non digit characters
            number = number.replace(/\D/g, '');
            
            for (let i = number.length - 1; i >= 0; i--) {
                let digit = parseInt(number.charAt(i));

                if (isEven) {
                    digit *= 2;
                    if (digit > 9) {
                        digit -= 9;
                    }
                }

                sum += digit;
                isEven = !isEven;
            }

            return (sum % 10) === 0;
        }

        function getCardType(number) {
            // Remove spaces and non-digit characters
            number = number.replace(/\D/g, '');
            
            // Card patterns
            const patterns = {
                visa: /^4[0-9]{12}(?:[0-9]{3})?$/,
                mastercard: /^5[1-5][0-9]{14}$/,
                amex: /^3[47][0-9]{13}$/,
                discover: /^6(?:011|5[0-9]{2})[0-9]{12}$/
            };

            for (let card in patterns) {
                if (patterns[card].test(number)) {
                    return card.charAt(0).toUpperCase() + card.slice(1);
                }
            }
            
            return 'Unknown';
        }

        function isExpiryValid(expiry) {
            const [month, year] = expiry.split('/').map(num => parseInt(num));
            const now = new Date();
            const currentYear = now.getFullYear() % 100; // Get last 2 digits
            const currentMonth = now.getMonth() + 1; // getMonth() returns 0-11

            if (!month || !year) return false;
            if (month < 1 || month > 12) return false;
            if (year < currentYear) return false;
            if (year === currentYear && month < currentMonth) return false;

            return true;
        }

        // Update the card input event listener
        function setupCardValidation(cardInput, expiryInput) {
            const cardTypeDisplay = document.createElement('div');
            cardTypeDisplay.className = 'text-sm text-gray-400 mt-1';
            cardInput.parentNode.appendChild(cardTypeDisplay);

            const cardValidityDisplay = document.createElement('div');
            cardValidityDisplay.className = 'text-sm mt-1';
            cardInput.parentNode.appendChild(cardValidityDisplay);

            cardInput.addEventListener('input', function(e) {
                // Existing formatting
                formatCardNumber(e.target);
                
                // Card type detection
                const cardType = getCardType(e.target.value);
                cardTypeDisplay.textContent = `Card Type: ${cardType}`;
                
                // Card validation
                const isValid = validateCard(e.target.value);
                cardValidityDisplay.textContent = e.target.value.length >= 16 ? 
                    (isValid ? ' Valid card number' : ' Invalid card number') : '';
                cardValidityDisplay.className = 'text-sm mt-1 ' + 
                    (isValid ? 'text-green-500' : 'text-red-500');
            });

            if (expiryInput) {
                const expiryValidityDisplay = document.createElement('div');
                expiryValidityDisplay.className = 'text-sm mt-1';
                expiryInput.parentNode.appendChild(expiryValidityDisplay);

                expiryInput.addEventListener('input', function(e) {
                    // Existing formatting
                    formatExpiryDate(e.target);
                    
                    // Expiry validation
                    if (e.target.value.includes('/')) {
                        const isValid = isExpiryValid(e.target.value);
                        expiryValidityDisplay.textContent = isValid ? 
                            ' Valid expiry date' : ' Expired or invalid date';
                        expiryValidityDisplay.className = 'text-sm mt-1 ' + 
                            (isValid ? 'text-green-500' : 'text-red-500');
                    } else {
                        expiryValidityDisplay.textContent = '';
                    }
                });
            }
        }

        // Update the payment form setup
        const originalSetupPaymentFormValidation = window.setupPaymentFormValidation;
        window.setupPaymentFormValidation = function(form) {
            originalSetupPaymentFormValidation(form);
            
            const cardInput = form.querySelector('input[name="cardNumber"]');
            const expiryInput = form.querySelector('input[name="expiry"]');
            
            if (cardInput) {
                setupCardValidation(cardInput, expiryInput);
            }
        };

        // Add this validation function
        function isValidPayment(form) {
            const cardNumber = form.querySelector('input[name="cardNumber"]').value.replace(/\s/g, '');
            const expiry = form.querySelector('input[name="expiry"]').value;
            const cvc = form.querySelector('input[name="cvc"]').value;

            // Check card number using Luhn algorithm
            if (!validateCard(cardNumber)) {
                alert('Invalid card number. Please check and try again.');
                return false;
            }

            // Check expiry date
            if (!isExpiryValid(expiry)) {
                alert('Invalid or expired card. Please check the expiry date.');
                return false;
            }

            // Check CVC
            if (!/^\d{3}$/.test(cvc)) {
                alert('Invalid CVC number. Please enter a valid 3-digit CVC.');
                return false;
            }

            return true;
        }

        // Update the form submission handler
        const originalHandleSubmit = window.handleSubmit;
        window.handleSubmit = function(event) {
            event.preventDefault();
            const form = event.target;
            
            // Validate payment before proceeding
            if (!isValidPayment(form)) {
                return false;
            }
            
            // If validation passes, proceed with original submission
            originalHandleSubmit.call(this, event);
        };

        // Update the simple payment form submission
        const originalSimplePaymentSubmit = window.handleSimplePaymentSubmit;
        window.handleSimplePaymentSubmit = function(event) {
            event.preventDefault();
            const form = event.target;
            
            // Validate payment before proceeding
            if (!isValidPayment(form)) {
                return false;
            }
            
            // If validation passes, proceed with original submission
            originalSimplePaymentSubmit.call(this, event);
        };
    </script>
</body>
</html>
